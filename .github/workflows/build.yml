name: Build and Package

on:
  push:
    branches: [ main, master, dev ]
  pull_request:
    branches: [ main, master, dev ]
  workflow_dispatch:

jobs:
  build-backend:
    name: Build Backend (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: backend

      - name: Build Backend
        run: cargo build --release
        working-directory: backend

      - name: Upload Backend Binary
        uses: actions/upload-artifact@v4
        with:
          name: backend-linux
          path: backend/target/release/backend-service

  build-frontend:
    name: Build Frontend (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: mvn clean package -DskipTests
        working-directory: frontend/web-mockup/v0-javafx-port

      - name: Prepare jpackage input
        shell: bash
        run: |
          mkdir -p jpackage-input
          cp target/*.jar jpackage-input/
          if [ -d "target/libs" ]; then
            cp target/libs/*.jar jpackage-input/
          fi
        working-directory: frontend/web-mockup/v0-javafx-port

      - name: Package with jpackage
        shell: bash
        run: |
          MAIN_JAR=$(basename $(ls target/stars-*.jar | head -n 1))
          echo "Using main jar: $MAIN_JAR"
          
          # Determine package type based on OS
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            PACKAGE_TYPE="msi"
            # Add console and install options for windows
            EXTRA_OPTS="--win-console --win-dir-chooser --win-shortcut"
          else
            PACKAGE_TYPE="dmg"
            EXTRA_OPTS=""
          fi

          jpackage \
            --type "$PACKAGE_TYPE" \
            --input jpackage-input \
            --dest dist \
            --name "StarsApp" \
            --main-jar "$MAIN_JAR" \
            --main-class com.example.appstore.Launcher \
            --description "Stars Desktop App Store" \
            --vendor "Stardive" \
            $EXTRA_OPTS
        working-directory: frontend/web-mockup/v0-javafx-port

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-${{ matrix.os }}
          path: |
            frontend/web-mockup/v0-javafx-port/dist/*.msi
            frontend/web-mockup/v0-javafx-port/dist/*.dmg
            frontend/web-mockup/v0-javafx-port/dist/*.exe
